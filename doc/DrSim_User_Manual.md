# DrSim User Manual
## General framework of DrSim
* **DrSim** is a learning-based framework designed to assign a label to a query transcriptional signature by using a similarity learned from reference transcriptional signatures, rather than empirical design. The basic idea of DrSim is a similarity learning schema that aims at making query signatures and reference signatures belonging to identical class more similar, while making query signatures and reference signatures belonging to different classes more dissimilar. DrSim comprises three main steps: data preprocessing, model training, and similarity calculation.
  * **Data preprocessing**: The inputs of DrSim are reference signatures and a query signature that is calculated from phenotype of interest.
    * **Preparation of reference signatures**: (1) Transcriptional signatures treated by compounds for 6H or 24H in the nine human cancer cell lines in LINCS are retained;  (2) signatures in LINCS are split into 18 subsets according to the cell type and time point.
    * **Preparation of query signatures**: Query signatures were collected by comparing gene expression profiles from cancer cell lines or tumor tissues to the corresponding normal tissues using robust zscore.
  * **Model training**: By adopting the linear discriminant analysis (LDA) metric learning algorithm, DrSim automatically infers a transcriptional similarity measurement for query assignment based on the reference signatures. Briefly:
    * The principal component analysis (PCA) was applied to reference signatures to denoise and reduce dimensionality. A transformation matrix P is learned.
    * By applying LDA to the dimensionality-reduced signatures, a transformation matrix L is learned based on the signature labels indicating similarities and dissimilarities between signatures. The label of a signature is the compound class. The transformation matrix L that fits the relationships between signatures will project signatures into another space, in which signatures belonging to the identical class stay close to each other (intraclass similarity) while signatures belonging to different classes stay away from each other (interclass dissimilarity). In summary, the basic idea of LDA is to learn an optimal transformation matrix L that leads to the optimal similarity measurement that aims at maximizing intraclass similarity and interclass dissimilarity.
    * The transformed references denoted as TR belonging to the identical class are median centered to obtain the transformed median centered references (denoted as TMR).
  * **Similarity calculation**: For a query signature, after transformation by the P and L matrix, its similarities to the TMR are calculated by cosine similarity. The similarity score matrix is then ranked and can be used for query assignment. In drug annotation applications, the label of a query is assigned as the label of the reference that is most similar to the query since a positive score indicates compounds sharing a similar mechanism and activity. In drug repositioning applications, compounds that have the largest negative scores for the query are suggested since a negative score indicates that exposure to a particular compound can reverse the phenotype of interest.

## **Tutorial**
### **Drug annotation**
* For illustration purposes, we took the query signatures generated by treating A375 for 24H in LINCS as examples. To minimize the influence of cell line and time point in calculating similarities between compound-induced signatures, the signatures generated by treating A375 for 24H are used as references. For easy-to-use, all the 18 subset reference signatures that can be used for drug annotation in LINCS are available at [onedrive](https://tongjieducn-my.sharepoint.com/:f:/g/personal/1810546_tongji_edu_cn/EsGz1_ulnkBOr4KIW3RIw04BNkB01ShvpfL5aNnosFrfCw?e=hJi0N9). The example query signatures are available at [onedrive](https://tongjieducn-my.sharepoint.com/:f:/g/personal/1810546_tongji_edu_cn/EilBAh48yfNCmgXZGu1kF5AB845goXLHllwhg1Q8d9akjg?e=pusKSM).    
    * **Preparation of query signatures** 
    ```r
    python  DrugAno.py  --help
    ## if the expression profiles are sequenced by microarray platform and have been normalized such as profiles in CMap and LINCS:
    python  preQuery.py  -tumor A375_tumorExp.tsv  -normal A375_controlExp.tsv  
    ## if the expression profiles are sequenced by RNA-seq platform and have been normalized to fpkm such as profiles in TCGA:
    python  preQuery.py  -tumor A375_tumorExp.tsv  -normal A375_controlExp.tsv  -log2 
    ## if the expression profiles are raw RNAseq counts such as profiles in GEO:
    python  preQuery.py  -tumor A375_tumorExp.tsv  -normal A375_controlExp.tsv  -normalize
    ```  
    
    * **Model training and similarity calculation** 
    ```r
    ## for example, input compound signatures generated by treating A375 for 24H
    python  DrugAno.py  -ref  A375/DrugAnoRef_24H.h5  -query  A375_24H.tsv
    ```
    
    * **Output column explanation**
    
    | Query ID           | MOA description 1 | MOA description 2 | MOA scores 1 | MOA scores 2|
    | :-----------: | :-----------: | :--------: | :--------: | :--------: | 
    | Query ID 1               | RAF inhibitor | HDAC inhibitor | 0.831 | 0.731 |  
    | Query ID 2               | CDK activator  | Na+ ch. blocker | 0.732  | 0.693| 



     
    
### **Drug repositioning**
* For illustation purposes, we took the BRCA disease signature in TCGA as examples. To minimize the influence of cell line and time point in calculating similarities between compound-induced signatures, the signatures generated by treating MCF7 for 6H and 24H are used as references. For easy-to-use, all the 18 subset reference signatures that can be used for drug repositioning in LINCS are available from [onedrive](https://tongjieducn-my.sharepoint.com/:f:/g/personal/1810546_tongji_edu_cn/EsGz1_ulnkBOr4KIW3RIw04BNkB01ShvpfL5aNnosFrfCw?e=hJi0N9). The example query signatures are available at [onedrive](https://tongjieducn-my.sharepoint.com/:f:/g/personal/1810546_tongji_edu_cn/EilBAh48yfNCmgXZGu1kF5AB845goXLHllwhg1Q8d9akjg?e=pusKSM).
    * **Preparation of query signatures** 
    ```r
    python preQuery --help 
    # if the expression profiles are sequenced by RNA-seq platform and have been normalized to fpkm such as profiles in TCGA:
    python preQuery -tumor BRCA_tumorExp.tsv -normal BRCA_controlExp.tsv  -log2  -output  BRCA_Query.tsv 
    ## if the expression profiles are raw RNAseq counts such as profiles in GEO, for example:
    python preQuery -tumor MCF7_tumorExp.tsv -normal MCF7_controlExp.tsv  -normalize
    ```
    
    * **Model training and similarity calculation**
    ```r
    python  DrugRep.py  -ref  MCF7/DrugRepRef_24H.h5  -query  BRCA_Query.tsv  
    python  DrugRep.py  -ref  MCF7/DrugRepRef_6H.h5   -query  BRCA_Query.tsv 
    ```
    
    * **Output column explanation**
        
    | Drug ID | Drug score  | MOA description |
    | :-----------: | :-----------: |:----------:|
    | Methotrexate               | -0.472 |  Dihydrofolate reductase inhibitor  |
    | Tioguanine               | -0.401 |   Antimetabolite | 
    

    
    















