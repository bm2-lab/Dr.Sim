# Dr.Sim User Manual
## General framework of Dr.Sim
* **Dr.Sim** is a learning-based framework designed to assign a label to a query transcriptional signature by measuring the similarity between the query transcriptional signature and each reference transcriptional signature cluster centroid using a measurement learned from reference transcriptional signatures, rather than empirically designing. The basic idea of Dr. Sim is a similarity learning schema which aims at making query signatures and reference signatures belonging to identical class become more similar, while query signatures and reference signatures belonging to different classes become more dissimilar. In this study, for illustration purpose, LINCS is used as the reference transcriptional signatures data resource since it holds the largest-scale signatures that produced by treating human cancer cell lines with different compounds under different conditions. Nevertheless, the application of Dr.Sim is not restricted to LINCS and it can be applied directly to other transcriptional perturbation-based data resources for phenotypic drug discovery. Basically, Dr.Sim comprises three main steps: data preprocessing, model training, and similarity calculation.
  * **Data preprocessing**: The inputs of Dr.Sim are reference signatures and a query signature that is calculated from phenotype of interest.
    * **Preparation of reference signatures**: (1) Transcriptional signatures treated by compounds for 6H or 24H in the nine human cancer cell lines in LINCS are retained;  (2) signatures in LINCS are split into 18 subsets according to cell type and time-point.
    * **Preparation of query signatures**: Query signatures were collected by comparing gene expression profiles from cancer cell lines or tumor tissues to the corresponding normal tissues.
  * **Model training**: By adopting the linear discriminant analysis (LDA) metric learning algorithm, Dr.Sim automatically infers a transcriptional similarity measurement 
used for query assignment based on the reference signatures. Briefly:
    * The principal component analysis (PCA) was applied to reference signatures to denoise and reduce dimensionality. A transformation matrix P is learned.
    * Through applying LDA to the dimensionality reduced signatures, a transformation matrix L is learned based on the signature labels indicating similarities and dissimilarities between signatures. The label of a signature is the compound class. The transformation matrix L that fits the relationships between signatures will project signatures into another space, in which signatures belonging to the identical class stay closely with each other (intra-class similarity) while signatures belonging to different classes stay away from each other (inter-class dissimilarity). In summary, the basic idea of LDA is to learn an optimal transformation matrix L that leads to the optimal similarity measurement that aims at maximizing intra-class similarity and inter-class dissimilarity.
    * The transformed references denoted as TR belonging to the identical class are median centered to derive the transformed median centered references (denoted as TMR).
  * **Similarity calculation**: For a query signature, after transformed by the P and L matrix, its similarities to the TMR were calculated by cosine similarity. The similarity score matrix was further ranked and it can be used for query assignment. In drug annotation application, the label of a query is assigned as the label of the reference that is most similar to the query since a positive score indicates compounds sharing a similar mechanism and activity. In drug repositioning application, compounds that have the largest negative scores to the query are suggested since a negative score indicates the exposure to a particular compound can reverse the phenotype of interest.

## **Tutorial**
### **Drug annotation**
* For illustration purpose, we took the query signature generated by treating A375 for 24H as examples. To minimize the influence of cell line and time-point in calculating similarities between compound-induced signatures, the signatures generated by treating A375 for 24H is used as references. For easy-to-use, all the 18 subset reference signatures that can be used for drug annotation in LINCS are available from [].  
    * **Preparation of query signatures** 
    ```r
    python  DrugAno.py  --help
    ## if the expression profiles are sequenced by micro-array and have been normalized such as profiles in CMap and LINCS:
    python  preQuery.py  -tumor A375_tumorExp.tsv  -normal A375_controlExp.tsv  
    ## if the expression profiles are sequenced by RNAseq and have been normalized to fpkm such as profiles in TCGA:
    python  preQuery.py  -tumor A375_tumorExp.tsv  -normal A375_controlExp.tsv  -log2 
    ## if the expression profiles are raw RNAseq counts such as profiles in GEO:
    python  preQuery.py  -tumor A375_tumorExp.tsv  -normal A375_controlExp.tsv  -normalize
    ```  
    
    * **Model training and similarity calculation** 
    ```r
    python  DrugAno.py  -ref  DrugAnoRef_24H.h5  -query  A375_24H.tsv
    ```
    
    * **output**  
    By default, the results contails ten MOAs that have largest similarities to the query.       


| Column Name           | Description |
| -----------           | ----------- |
| pert_id               | id in the CMap Touchstone |
| TAG                   | Compound CMap score |
| pert_iname            | Compound name |
| Toxicity              | Whether the identified compound is toxic or not|


     
    
### **Drug repositioning**
* For illustation purpose, we took the BRCA disease signature as examples. To minimize the influence of cell line and time-point in calculating similarities between compound-induced signatures, the signatures generated by treating MCF7 for 6H and 24H is used as references. For easy-to-use, all the 18 subset reference signatures that can be used for drug repositioning in LINCS are available from [].
    * **Preparation of query signatures** 
    ```r
    python preQuery --help 
    # if the expression profiles are sequenced by RNAseq and have been normalized to fpkm such as profiles in TCGA:
    python preQuery -tumor BRCA_tumorExp.tsv -normal BRCA_controlExp.tsv -log2
    ## if the expression profiles are raw RNAseq counts such as profiles in GEO, for example:
    python preQuery -tumor MCF7_tumorExp.tsv -normal MCF7_controlExp.tsv -normalize
    ```
    
    * **Model training and similarity calculation**
    ```r
    python  DrugRep.py   -ref  DrugRepRef_24H.h5  -query  BRCA_Query.tsv 
    ```
    

    
    















